<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Geo Interactivo â€“ Maricunga</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>
  <style>
    :root { --gap: 12px; }
    html, body { margin:0; padding:0; height:100%; background:#fff; font-family: Arial, sans-serif; }
    .wrap {
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: var(--gap);
    }
    header { display:flex; align-items:center; justify-content:center; padding: var(--gap); }
    header img { max-width: 260px; height: auto; display:block; }
    main { display:flex; align-items:center; justify-content:center; overflow:auto; padding-bottom: var(--gap); }
    canvas { box-shadow: 0 10px 30px rgba(0,0,0,.08); border-radius: 12px; display:block; background:#f2f2f2; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="https://jdelafuentec.github.io/web/OA_Recurso48.png" alt="Logo OASIS" onerror="this.style.display='none'">
    </header>
    <main></main>
  </div>

  <script>
    // --- ParÃ¡metros base + escala 1.5x ---
    const BASE_W = 1275, BASE_H = 768, SCALE = 1.5;

    // ImÃ¡genes (URLs absolutas para evitar problemas de ruta)
    const BASE = "https://jdelafuentec.github.io/web/";
    let fondoBlanco, fondoMontana, nubeImg, lluviaImg, aguaRioImg;

    let capas = [];
    let capaActiva = null;

    let lluviaActiva=false, lluviaInicio=0;
    let mostrarNarracion1=false, mostrarNarracion2=false;
    let aguaActiva=false, rioClickable=false, capasActivas=false, mostrarCapaTemporal=false;

    let nubeX = 590, nubeY = 70;

    function loadSafe(path) {
      return loadImage(
        BASE + path,
        () => console.log("OK:", path),
        () => console.warn("NO CARGÃ“:", BASE + path)
      );
    }

    function preload() {
      // Fondos y elementos
      fondoBlanco = loadSafe("fondoBlanco.png");
      fondoMontana = loadSafe("montanas.png");
      nubeImg      = loadSafe("nube.png");
      lluviaImg    = loadSafe("lluvia.png");
      aguaRioImg   = loadSafe("aguaRio.png");

      // Capas
      capas.push({
        nombre:"Sulphates",
        descripcion:"Los sulfatos como el yeso (CaSOâ‚„Â·2Hâ‚‚O) o la epsomita se forman en etapas intermedias de evaporaciÃ³n. Su presencia refleja un ambiente quÃ­micamente mÃ¡s concentrado que favorece la precipitaciÃ³n de minerales con azufre.",
        img: loadSafe("sulphates.png"),
        imagenEjemplo: loadSafe("travertinoImg.png"),
        x:192, y:277
      });
      capas.push({
        nombre:"Travertinos",
        descripcion:"Roca sedimentaria carbonatada, compuesta principalmente de calcita (CaCOâ‚ƒ), que se forma por precipitaciÃ³n quÃ­mica a partir de aguas subterrÃ¡neas o termales ricas en carbonato de calcio.",
        img: loadSafe("travertines.png"),
        imagenEjemplo: loadSafe("travertinoImg.png"),
        x:380, y:189
      });
      capas.push({
        nombre:"Halite",
        descripcion:"La halita es sal comÃºn (NaCl), que precipita en las etapas finales del proceso de evaporaciÃ³n. Su presencia indica ambientes extremadamente salinos y condiciones de evaporaciÃ³n muy avanzadas.",
        img: loadSafe("halite.png"),
        imagenEjemplo: loadSafe("halite.png"),
        x:149, y:257
      });
      capas.push({
        nombre:"Carbonatos",
        descripcion:"Los carbonatos como la calcita (CaCOâ‚ƒ) se precipitan cuando hay pÃ©rdida de COâ‚‚ en aguas ricas en calcio.",
        img: loadSafe("carbonatos.png"),
        imagenEjemplo: loadSafe("carbonatoImg.png"),
        x:117, y:284
      });
    }

    function setup() {
      const c = createCanvas(BASE_W * SCALE, BASE_H * SCALE);
      c.parent(document.querySelector('main'));
      textFont('Arial');
      textSize(16);
      noStroke();
    }

    function draw() {
      // Fondo de seguridad para "ver algo" aunque no cargue ninguna imagen
      background(242); // gris claro

      // Coordenadas del mouse en sistema base (por la escala)
      const mx = mouseX / SCALE;
      const my = mouseY / SCALE;

      push();
      scale(SCALE);

      // Dibuja fondo/base (si no cargÃ³, pinta placeholders)
      if (fondoBlanco) image(fondoBlanco, 0, 0); else placeholder(0,0,BASE_W,BASE_H,"fondoBlanco.png");
      if (fondoMontana) image(fondoMontana, 0, 192); else placeholder(0,192,800,200,"montanas.png");

      // HOVER de capas (detecciÃ³n por alfa)
      let capaHover = null;
      if (capasActivas) {
        for (let capa of capas) {
          if (!capa.img) continue;
          if (mx >= capa.x && mx < capa.x + capa.img.width &&
              my >= capa.y && my < capa.y + capa.img.height) {
            const ix = int(mx - capa.x), iy = int(my - capa.y);
            let px;
            try { px = capa.img.get(ix, iy); } catch(e) { px = [0,0,0,0]; }
            if (px[3] > 10) capaHover = capa;
          }
        }
      }

      // Lluvia
      if (lluviaActiva) {
        const elapsed = millis() - lluviaInicio;
        if (elapsed < 2000) {
          const offset = map(elapsed, 0, 2000, 0, 60);
          if (lluviaImg) {
            image(lluviaImg, nubeX + 60, nubeY + 60 + offset);
            push();
            translate(nubeX + 60, nubeY + 60 + offset * 2 + lluviaImg.height);
            scale(1, -1);
            tint(255, 150);
            image(lluviaImg, 0, 0);
            pop();
            noTint();
          } else {
            placeholder(nubeX + 60, nubeY + 60 + offset, 60, 60, "lluvia.png");
          }
        }
      }

      // RÃ­o y nube
      if (aguaActiva) {
        if (aguaRioImg) image(aguaRioImg, 411, 266);
        else placeholder(411,266,180,80,"aguaRio.png");
      }
      if (nubeImg) image(nubeImg, nubeX, nubeY);
      else placeholder(nubeX, nubeY, 120, 80, "nube.png");

      // Capas visibles
      if (capasActivas && mostrarCapaTemporal) {
        for (let capa of capas) capa.img ? image(capa.img, capa.x, capa.y) : null;
      } else if (capasActivas && capaHover) {
        image(capaHover.img, capaHover.x, capaHover.y);
      } else if (capasActivas && capaActiva) {
        image(capaActiva.img, capaActiva.x, capaActiva.y);
      }

      // Etiqueta hover
      if (capaHover) {
        fill(0);
        text(capaHover.nombre, mx + 15, my - 12);
      }

      mostrarConsola();
      pop();

      // Info de ayuda si aÃºn no pasa nada
      fill(60); noStroke();
      text("Si ves fondo gris, el sketch estÃ¡ corriendo. Revisa la consola (F12) por 'NO CARGÃ“: ...'", 12, height - 12);
    }

    function mousePressed() {
      const mx = mouseX / SCALE;
      const my = mouseY / SCALE;

      if (nubeImg && mx >= nubeX && mx < nubeX + nubeImg.width && my >= nubeY && my < nubeY + nubeImg.height) {
        lluviaActiva = true; lluviaInicio = millis();
        mostrarNarracion1 = true; mostrarNarracion2 = false; capaActiva = null;
        setTimeout(()=>{ aguaActiva = true; rioClickable = true; }, 2000);
        return;
      }

      if (rioClickable && aguaRioImg &&
          mx >= 411 && mx < 411 + aguaRioImg.width && my >= 266 && my < 266 + aguaRioImg.height) {
        capasActivas = true; rioClickable = false;
        mostrarNarracion1 = false; mostrarNarracion2 = true; capaActiva = null;
        mostrarCapaTemporal = true; setTimeout(()=>{ mostrarCapaTemporal = false; }, 500);
        return;
      }

      if (capasActivas) {
        for (let capa of capas) {
          if (!capa.img) continue;
          if (mx >= capa.x && mx < capa.x + capa.img.width && my >= capa.y && my < capa.y + capa.img.height) {
            const ix = int(mx - capa.x), iy = int(my - capa.y);
            let px;
            try { px = capa.img.get(ix, iy); } catch(e) { px = [0,0,0,0]; }
            if (px[3] > 10) { capaActiva = capa; mostrarNarracion1 = false; mostrarNarracion2 = false; }
          }
        }
      }
    }

    function mostrarConsola() {
      const alto = 230, yBase = BASE_H - alto - 530;
      fill(255); stroke(0); rect(10, yBase, 500, alto); noStroke(); fill(0);

      text("ðŸ›ˆ Instrucciones:", 20, yBase + 20);
      if (!aguaActiva)        text("- Presiona la nube para comenzar.", 20, yBase + 36);
      else if (!capasActivas) text("- Presiona el rÃ­o para continuar.", 20, yBase + 36);
      else                    text("- Explora los elementos haciendo clic sobre ellos.", 20, yBase + 36);

      text("Â¿QuÃ© estÃ¡ ocurriendo?:", 20, yBase + 58);
      const yTexto = yBase + 72;

      if (mostrarNarracion1)
        text("Las altas cumbres de la cordillera alimentan el sistema...", 20, yTexto, 460);
      if (mostrarNarracion2)
        text("A medida que el agua avanza, se transforma quÃ­micamente...", 20, yTexto, 460);

      if (capaActiva) {
        if (capaActiva.imagenEjemplo) image(capaActiva.imagenEjemplo, 25, yTexto + 10, 80, 80);
        textStyle(BOLD);   text(capaActiva.nombre, 120, yTexto + 30);
        textStyle(NORMAL); text(capaActiva.descripcion, 120, yTexto + 50, 370);
      }
    }

    // Placeholder rojo si falta algo
    function placeholder(x,y,w,h,label){
      push(); noFill(); stroke(200,0,0); strokeWeight(2); rect(x,y,w,h);
      noStroke(); fill(200,0,0); textSize(12); text(label, x+6, y+16); pop();
    }
  </script>
</body>
</html>
