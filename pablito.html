<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parques | Lista + 1 Mapa</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Turf (opcional: calcular longitudes de senderos) -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <style>
    /* --- Layout de 2 columnas (1/3 lista, 2/3 mapa) --- */
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .layout { display: flex; height: 100vh; width: 100vw; }

    .sidebar {
      flex: 0 0 33.333%;
      min-width: 260px; max-width: 420px;
      border-right: 1px solid #e5e7eb;
      background: #fafafa;
      padding: 16px 14px;
      overflow: auto;
    }
    .sidebar h2 { margin: 0 0 10px; font-size: 18px; }
    .sidebar p  { margin: 0 0 12px; font-size: 13px; color: #666; }

    .parks { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
    .parks a {
      display: block; text-decoration: none; color: #0a3d91; background: #fff;
      border: 1px solid #e3e7ef; border-radius: 10px; padding: 10px 12px;
      transition: background .15s ease, border-color .15s ease, transform .06s ease;
      cursor: pointer;
    }
    .parks a:hover { background: #f0f6ff; border-color: #cfe0ff; transform: translateY(-1px); }
    .parks small { color: #6b7280; display: block; margin-top: 3px; }

    .map-wrap { flex: 1 1 66.666%; position: relative; }
    #map { position: absolute; inset: 0; }

    .legend {
      position: absolute; left: 12px; bottom: 12px; background: #fff; padding: .5rem .75rem;
      border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.08); font-size: 13px; line-height: 1.25;
    }
    .legend .sw { display:inline-block; width:12px; height:12px; border-radius:3px; margin-right:6px; vertical-align:-2px; }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Columna izquierda: lista de los 17 parques (un solo mapa) -->
    <aside class="sidebar">
      <h2>Parques</h2>
      <p>Click en un parque para enfocar el <strong>mismo mapa</strong> y ver senderos (zoom ≥ 12).</p>
      <ul class="parks" id="parkList">
        <li><a href="/parques/parque-1.html"  data-name="Parque 1">Parque 1<small>/parques/parque-1.html</small></a></li>
        <li><a href="/parques/parque-2.html"  data-name="Parque 2">Parque 2<small>/parques/parque-2.html</small></a></li>
        <li><a href="/parques/parque-3.html"  data-name="Parque 3">Parque 3<small>/parques/parque-3.html</small></a></li>
        <li><a href="/parques/parque-4.html"  data-name="Parque 4">Parque 4<small>/parques/parque-4.html</small></a></li>
        <li><a href="/parques/parque-5.html"  data-name="Parque 5">Parque 5<small>/parques/parque-5.html</small></a></li>
        <li><a href="/parques/parque-6.html"  data-name="Parque 6">Parque 6<small>/parques/parque-6.html</small></a></li>
        <li><a href="/parques/parque-7.html"  data-name="Parque 7">Parque 7<small>/parques/parque-7.html</small></a></li>
        <li><a href="/parques/parque-8.html"  data-name="Parque 8">Parque 8<small>/parques/parque-8.html</small></a></li>
        <li><a href="/parques/parque-9.html"  data-name="Parque 9">Parque 9<small>/parques/parque-9.html</small></a></li>
        <li><a href="/parques/parque-10.html" data-name="Parque 10">Parque 10<small>/parques/parque-10.html</small></a></li>
        <li><a href="/parques/parque-11.html" data-name="Parque 11">Parque 11<small>/parques/parque-11.html</small></a></li>
        <li><a href="/parques/parque-12.html" data-name="Parque 12">Parque 12<small>/parques/parque-12.html</small></a></li>
        <li><a href="/parques/parque-13.html" data-name="Parque 13">Parque 13<small>/parques/parque-13.html</small></a></li>
        <li><a href="/parques/parque-14.html" data-name="Parque 14">Parque 14<small>/parques/parque-14.html</small></a></li>
        <li><a href="/parques/parque-15.html" data-name="Parque 15">Parque 15<small>/parques/parque-15.html</small></a></li>
        <li><a href="/parques/parque-16.html" data-name="Parque 16">Parque 16<small>/parques/parque-16.html</small></a></li>
        <li><a href="/parques/parque-17.html" data-name="Parque 17">Parque 17<small>/parques/parque-17.html</small></a></li>
      </ul>
    </aside>

    <!-- Columna derecha: único mapa -->
    <section class="map-wrap">
      <div id="map"></div>
      <div class="legend">
        <div><span class="sw" style="background:#1e90ff"></span>Senderos (zoom ≥ 12)</div>
        <div><span class="sw" style="background:#3388ff"></span>Parques</div>
      </div>
    </section>
  </div>

  <script>
    // URLs de tus datos (un solo mapa los contiene a todos)
    const URL_PARQUES  = "https://jdelafuentec.github.io/web/parques.geojson";
    const URL_SENDEROS = "https://jdelafuentec.github.io/web/senderos.geojson";

    // Parámetros
    const INITIAL_CENTER = [-35.0, -72.5];
    const INITIAL_ZOOM   = 8;    // parte desde lejos (no muestra senderos)
    const Z_SENDEROS     = 12;   // umbral para ver senderos
    const Z_FLYTO        = 13;   // zoom al que volamos al seleccionar un parque

    // Mapa base
    const map = L.map('map', { center: INITIAL_CENTER, zoom: INITIAL_ZOOM, minZoom: 3 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contrib.' }).addTo(map);

    // Capas
    const trailColor = '#1e90ff';
    function trailStyle(){ return { color: trailColor, weight: 3, opacity: 0.9 }; }
    let parquesLayer, senderosLayer, senderosEnMapa = false;
    const parqueIndex = new Map();  // name -> marker

    function kmFromGeoJSON(geom){ try { return Math.round(turf.length(geom,{units:'kilometers'})*100)/100; } catch { return null; } }

    // Mostrar/ocultar senderos según zoom
    function actualizarSenderosPorZoom(){
      if (!senderosLayer) return;
      const z = map.getZoom();
      if (z >= Z_SENDEROS) { if (!senderosEnMapa){ senderosLayer.addTo(map); senderosEnMapa = true; } }
      else { if (senderosEnMapa){ map.removeLayer(senderosLayer); senderosEnMapa = false; } }
    }
    map.on('zoomend', actualizarSenderosPorZoom);

    // Cargar datos una sola vez para el único mapa
    Promise.all([ fetch(URL_PARQUES).then(r=>r.json()), fetch(URL_SENDEROS).then(r=>r.json()) ])
      .then(([parques, senderos]) => {
        // --- Parques ---
        parquesLayer = L.geoJSON(parques, {
          pointToLayer: (f, latlng) => L.marker(latlng, { title: f.properties?.name || 'Parque' }),
          onEachFeature: (f, layer) => {
            const p = f.properties || {};
            const name = (p.name || '').trim();
            if (name) {
              layer.bindTooltip(name, { direction:'top', offset:[0,-6], sticky:true, opacity:.95 });
              parqueIndex.set(name.toLowerCase(), layer);
            }
            layer.bindPopup(`<strong>${name || 'Parque'}</strong><br>${(p.description || '')}`);
            layer.on('click', (e) => {
              const url = (p.url || '').toString().trim();
              if (url) window.open(url, '_blank', 'noopener');
              else {
                map.flyTo(e.latlng, Math.max(map.getZoom(), Z_FLYTO), { duration: .6 });
                setTimeout(actualizarSenderosPorZoom, 650);
              }
            });
          }
        }).addTo(map);

        // --- Senderos (arrancan ocultos) ---
        senderosLayer = L.geoJSON(senderos, {
          style: trailStyle,
          onEachFeature: (f, layer) => {
            const props = f.properties || {};
            const km = kmFromGeoJSON(f.geometry);
            layer.bindPopup(`<strong>${props.name || 'Sendero'}</strong><br>
              Longitud: ${km ?? '—'} km<br>
              Dificultad: ${props.difficulty || '—'}<br>
              Superficie: ${props.surface || '—'}`);
          }
        });
        actualizarSenderosPorZoom();

        // Click en la lista (mismo mapa, sin cambiar de página)
        document.getElementById('parkList').addEventListener('click', (e) => {
          const a = e.target.closest('a[data-name]');
          if (!a) return;

          // Ctrl/cmd + click: permite navegar al link futuro; click normal controla el mapa.
          if (e.ctrlKey || e.metaKey) return;
          e.preventDefault();

          const wanted = a.dataset.name.trim().toLowerCase();
          const marker = parqueIndex.get(wanted);
          if (marker) {
            const ll = marker.getLatLng();
            map.flyTo(ll, Math.max(map.getZoom(), Z_FLYTO), { duration: .6 });
            marker.openPopup();
            setTimeout(actualizarSenderosPorZoom, 650);
          } else {
            console.info(`"${a.dataset.name}" aún no existe en parques.geojson (link de referencia).`);
          }
        });
      })
      .catch(err => {
        console.error('Error cargando GeoJSON:', err);
        alert('No se pudieron cargar los GeoJSON. Revisa la consola del navegador.');
      });

    // Ajuste visual si el contenedor cambia
    setTimeout(()=>map.invalidateSize(), 250);
  </script>
</body>
</html>
