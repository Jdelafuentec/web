<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Puzzle Salares - Proyecto OASIS</title>
    <style>
        body { 
            font-family: sans-serif; 
            text-align: center; 
            background-color: #ffffff; 
            margin: 0; 
            padding: 10px; 
            overscroll-behavior-y: contain; 
        }
        .logo { max-width: 180px; margin: 15px auto; display: block; }
        h1 { font-size: 1.2rem; color: #2c3e50; margin: 5px 0; }
        .instrucciones { font-size: 0.8rem; color: #888; margin-bottom: 15px; }

        #contenedor-juego { margin: 0 auto; width: fit-content; touch-action: none; }
        
        #tablero {
            display: grid;
            grid-template-columns: repeat(4, 75px);
            grid-template-rows: repeat(4, 75px);
            gap: 4px;
            background-color: #ddd;
            border: 2px solid #333;
            padding: 4px;
        }

        /* Ajustes para PC */
        @media (min-width: 450px) {
            #tablero { grid-template-columns: repeat(4, 100px); grid-template-rows: repeat(4, 100px); }
            .pieza { width: 100px !important; height: 100px !important; }
            #imagen-final { max-width: 412px !important; } /* Tamaño del tablero en PC */
        }

        .pieza {
            width: 75px;
            height: 75px;
            background-size: cover;
            border-radius: 2px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .seleccionada { 
            outline: 4px solid #27ae60; 
            z-index: 10; 
            transform: scale(1.05); 
        }

        /* --- CORRECCIÓN AQUÍ: Imagen final controlada --- */
        #imagen-final { 
            display: none; 
            margin: 0 auto; 
            border: 4px solid #27ae60; 
            border-radius: 5px;
            /* Esto obliga a la imagen a no ser más ancha que el puzzle */
            width: 100%;
            max-width: 312px; /* Tamaño del tablero en móvil (75*4 + gaps) */
            height: auto; 
            animation: fadeIn 0.8s;
        }

        #contenedor-mensaje { 
            display: none; 
            padding: 20px; 
            max-width: 500px; 
            margin: 0 auto; 
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #texto-info { 
            text-align: justify; 
            line-height: 1.6; 
            font-size: 1rem; 
            color: #444; 
            border-top: 3px solid #27ae60; 
            padding-top: 15px; 
        }

        .btn-reiniciar { 
            margin-top: 20px; 
            padding: 15px 30px; 
            background: #27ae60; 
            color: white; 
            border: none; 
            border-radius: 25px; 
            font-weight: bold; 
        }
    </style>
</head>
<body>

    <img src="https://jdelafuentec.github.io/web/OA_Recurso%2048.png" class="logo">
    <h1>Conoce los Salares Altoandinos</h1>
    <p id="instrucciones" class="instrucciones">Intercambia las piezas vecinas para completar el tapete.</p>

    <div id="contenedor-juego">
        <div id="tablero"></div>
        <img id="imagen-final" src="https://jdelafuentec.github.io/web/piezas_muestraTapete/original_muestraTapete.jpg">
    </div>

    <div id="contenedor-mensaje">
        <div id="texto-info">
            Un tapete microbiano en Maricunga es una capa visible de microorganismos (principalmente bacterias y cianobacterias) que vive sobre sedimentos húmedos y salinos del salar, formando uno de los ecosistemas más antiguos y resistentes de la Tierra.
        </div>
        <button class="btn-reiniciar" onclick="iniciar()">Jugar de nuevo</button>
    </div>

    <script>
        const tablero = document.getElementById('tablero');
        const imgFinal = document.getElementById('imagen-final');
        const mensaje = document.getElementById('contenedor-mensaje');
        const inst = document.getElementById('instrucciones');
        const BASE_URL = "https://jdelafuentec.github.io/web/piezas_muestraTapete/";
        
        let seleccionada = null;

        function iniciar() {
            tablero.innerHTML = '';
            tablero.style.display = 'grid';
            imgFinal.style.display = 'none';
            mensaje.style.display = 'none';
            inst.style.display = 'block';
            seleccionada = null;

            let piezas = [];
            for (let i = 0; i < 16; i++) {
                const f = Math.floor(i / 4);
                const c = i % 4;
                piezas.push({ id: i, url: `${BASE_URL}pieza_${f}_${c}.png` });
            }

            piezas.sort(() => Math.random() - 0.5);

            piezas.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = 'pieza';
                div.style.backgroundImage = `url('${p.url}')`;
                div.dataset.idOriginal = p.id; 
                div.dataset.indexActual = index; 

                div.onclick = tocar;
                tablero.appendChild(div);
            });
        }

        function tocar() {
            if (!seleccionada) {
                seleccionada = this;
                this.classList.add('seleccionada');
            } else {
                if (this === seleccionada) {
                    this.classList.remove('seleccionada');
                    seleccionada = null;
                } else if (sonVecinas(seleccionada, this)) {
                    intercambiar(seleccionada, this);
                    seleccionada.classList.remove('seleccionada');
                    seleccionada = null;
                    revisar();
                } else {
                    seleccionada.classList.remove('seleccionada');
                    seleccionada = this;
                    this.classList.add('seleccionada');
                }
            }
        }

        function sonVecinas(p1, p2) {
            const i1 = parseInt(p1.dataset.indexActual);
            const i2 = parseInt(p2.dataset.indexActual);
            const r1 = Math.floor(i1 / 4), c1 = i1 % 4;
            const r2 = Math.floor(i2 / 4), c2 = i2 % 4;
            return (Math.abs(r1 - r2) + Math.abs(c1 - c2)) === 1;
        }

        function intercambiar(p1, p2) {
            const imgTmp = p1.style.backgroundImage;
            p1.style.backgroundImage = p2.style.backgroundImage;
            p2.style.backgroundImage = imgTmp;

            const idTmp = p1.dataset.idOriginal;
            p1.dataset.idOriginal = p2.dataset.idOriginal;
            p2.dataset.idOriginal = idTmp;
        }

        function revisar() {
            const actuales = document.querySelectorAll('.pieza');
            let correctas = 0;
            actuales.forEach((p, i) => {
                if (parseInt(p.dataset.idOriginal) === i) correctas++;
            });

            if (correctas === 16) {
                setTimeout(() => {
                    tablero.style.display = 'none';
                    inst.style.display = 'none';
                    imgFinal.style.display = 'block';
                    mensaje.style.display = 'block';
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }, 400);
            }
        }

        iniciar();
    </script>
</body>
</html>
