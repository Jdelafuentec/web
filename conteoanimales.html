<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Contador de Pingüinos - Estilo Penguin Watch</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; background: #2c3e50; color: white; margin: 0; padding: 20px; }
        
        .controls { background: #34495e; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        #canvas-container { position: relative; cursor: crosshair; box-shadow: 0 0 30px rgba(0,0,0,0.5); overflow: hidden; border-radius: 4px; }
        
        canvas { max-width: 100%; height: auto; display: block; }

        /* Estilo de la Cruz */
        .marker {
            position: absolute;
            width: 12px;  /* Tamaño del área de la cruz */
            height: 12px;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* Líneas de la cruz (finas para no tapar) */
        .marker::before, .marker::after {
            content: '';
            position: absolute;
            background: #00ff00; /* Verde neón para alto contraste en rocas y pasto */
            box-shadow: 0 0 2px black; /* Borde sutil para que se vea en zonas blancas */
        }

        /* Línea horizontal */
        .marker::before {
            top: 50%;
            left: 0;
            width: 100%;
            height: 1px;
        }

        /* Línea vertical */
        .marker::after {
            left: 50%;
            top: 0;
            width: 1px;
            height: 100%;
        }

        #counter { font-size: 20px; font-weight: bold; background: #16a085; padding: 8px 15px; border-radius: 5px; }
        
        button { background: #e67e22; border: none; padding: 10px 20px; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #d35400; }
        input[type="file"] { color: #ecf0f1; }
    </style>
</head>
<body>

    <h2>Monitoreo de Población: Conteo con Cruz de Precisión</h2>
    
    <div class="controls">
        <input type="file" id="upload" accept="image/*">
        <div id="counter">Pingüinos: 0</div>
        <button onclick="exportData()">Descargar CSV</button>
        <button onclick="resetCanvas()" style="background:#c0392b;">Limpiar</button>
    </div>

    <div id="canvas-container">
        <canvas id="penguinCanvas"></canvas>
    </div>

    <script>
        const upload = document.getElementById('upload');
        const canvas = document.getElementById('penguinCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-container');
        const counterDisplay = document.getElementById('counter');
        
        let penguinData = [];
        let img = new Image();

        upload.addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    resetData();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        canvas.addEventListener('click', (e) => {
            if (!img.src) return;

            const rect = canvas.getBoundingClientRect();
            
            // Calculamos posición relativa al contenedor visual
            const visualX = e.clientX - rect.left;
            const visualY = e.clientY - rect.top;

            // Coordenadas reales en la imagen original (para el CSV)
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const realX = visualX * scaleX;
            const realY = visualY * scaleY;

            penguinData.push({ x: realX.toFixed(2), y: realY.toFixed(2) });
            
            // Crear la cruz visual
            const marker = document.createElement('div');
            marker.className = 'marker';
            marker.style.left = visualX + 'px';
            marker.style.top = visualY + 'px';
            container.appendChild(marker);

            counterDisplay.innerText = `Pingüinos: ${penguinData.length}`;
        });

        function resetData() {
            penguinData = [];
            counterDisplay.innerText = `Pingüinos: 0`;
            document.querySelectorAll('.marker').forEach(m => m.remove());
        }

        function resetCanvas() {
            if (img.src) ctx.drawImage(img, 0, 0);
            resetData();
        }

        function exportData() {
            if (penguinData.length === 0) return alert("Primero marca algunos pingüinos");
            
            let csvContent = "data:text/csv;charset=utf-8,ID,Coord_X,Coord_Y\n" 
                + penguinData.map((p, index) => `${index + 1},${p.x},${p.y}`).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "conteo_precision_patagonia.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
