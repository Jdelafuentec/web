<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Geo Interactivo â€“ Maricunga</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>
  <style>
    html, body { margin: 0; padding: 0; background:#fff; font-family: Arial, sans-serif; }
    main { min-height: 100vh; display: grid; place-items: center; padding: 12px; }
    canvas { box-shadow: 0 10px 30px rgba(0,0,0,.08); border-radius: 12px; }
  </style>
</head>
<body>
  <main></main>

  <script>
    const BASE = 'https://jdelafuentec.github.io/web/geo_interactivo/';

    let fondoBlanco, fondoMontana;
    let capas = [];
    let capaActiva = null;

    let nubeImg, lluviaImg, aguaRioImg;
    let lluviaActiva = false;
    let lluviaInicio = 0;
    let mostrarNarracion1 = false;
    let mostrarNarracion2 = false;

    let aguaActiva = false;
    let rioClickable = false;
    let capasActivas = false;
    let mostrarCapaTemporal = false;

    let nubeX = 590;
    let nubeY = 70;

    function preload() {
      fondoBlanco = loadImage(BASE + 'fondoBlanco.png');
      fondoMontana = loadImage(BASE + 'montanas.png');

      nubeImg = loadImage(BASE + 'nube.png');
      lluviaImg = loadImage(BASE + 'lluvia.png');
      aguaRioImg = loadImage(BASE + 'aguaRio.png');

      // === CAPAS EXPLORABLES (ACTUALIZADAS) ===
      capas.push({
        nombre: "Sulfatos",
        descripcion: "Los sulfatos como el yeso (CaSOâ‚„Â·2Hâ‚‚O) se forman en etapas intermedias de evaporaciÃ³n. Su presencia refleja un ambiente quÃ­micamente mÃ¡s concentrado que favorece la precipitaciÃ³n de minerales con azufre.",
        img: loadImage(BASE + 'sulphates.png'),
        imagenEjemplo: loadImage('https://picsum.photos/seed/sulphates/80'),
        x: 192, y: 277
      });

      capas.push({
        nombre: "Travertinos",
        descripcion: "Roca sedimentaria carbonatada, compuesta principalmente de calcita (CaCOâ‚ƒ), que se forma por precipitaciÃ³n quÃ­mica y orgÃ¡nica a partir de aguas subterrÃ¡neas o termales.",
        img: loadImage(BASE + 'travertines.png'),
        imagenEjemplo: loadImage(BASE + 'travertinoImg.png'),
        x: 380, y: 189
      });

      capas.push({
        nombre: "Cloruros (Halita)",
        descripcion: "Los cloruros, como la halita o sal comÃºn (NaCl), precipitan en las etapas finales del proceso de evaporaciÃ³n. Su presencia indica ambientes extremadamente salinos y condiciones de evaporaciÃ³n muy avanzadas.",
        img: loadImage(BASE + 'halite.png'),
        imagenEjemplo: loadImage('https://picsum.photos/seed/halite/80'),
        x: 149, y: 257
      });

      capas.push({
        nombre: "Carbonatos",
        descripcion: "Los carbonatos como la calcita (CaCOâ‚ƒ) se precipitan cuando hay pÃ©rdida de COâ‚‚ en aguas ricas en calcio. Reflejan ambientes donde hay menor salinidad, pero condiciones que favorecen la saturaciÃ³n de carbonato.",
        img: loadImage(BASE + 'carbonatos.png'),
        imagenEjemplo: loadImage(BASE + 'carbonatoImg.png'),
        x: 117, y: 284
      });

      // NUEVO: VegetaciÃ³n + QR
      capas.push({
        nombre: "VegetaciÃ³n",
        descripcion: "Escanea el QR para conocer la vegetaciÃ³n de Maricunga.",
        img: loadImage(BASE + 'vegetacion.png'),
        imagenEjemplo: loadImage(BASE + 'qrHerbario.png'),
        // posiciÃ³n sugerida (libre): ajusta si lo prefieres
        x: 650, y: 520
      });
    }

    function setup() {
      const c = createCanvas(1275, 768);
      c.parent(document.querySelector('main'));
      textFont('Arial');
      textSize(16);
      noStroke();
    }

    function draw() {
      background(255);
      image(fondoBlanco, 0, 0);
      image(fondoMontana, 0, 192);

      let capaHover = null;
      if (capasActivas) {
        for (let capa of capas) {
          if (
            mouseX >= capa.x && mouseX < capa.x + capa.img.width &&
            mouseY >= capa.y && mouseY < capa.y + capa.img.height
          ) {
            let imgX = int(mouseX - capa.x);
            let imgY = int(mouseY - capa.y);
            let c = capa.img.get(imgX, imgY);
            if (c[3] > 10) {
              capaHover = capa;
            }
          }
        }
      }

      // Lluvia animada
      if (lluviaActiva) {
        let elapsed = millis() - lluviaInicio;
        if (elapsed < 2000) {
          let offset = map(elapsed, 0, 2000, 0, 60);
          image(lluviaImg, nubeX + 60, nubeY + 60 + offset);
          push();
          translate(nubeX + 60, nubeY + 60 + offset * 2 + lluviaImg.height);
          scale(1, -1);
          tint(255, 150);
          image(lluviaImg, 0, 0);
          pop();
          noTint();
        }
      }

      if (aguaActiva) {
        image(aguaRioImg, 411, 266);
      }

      // Nube SIEMPRE visible (reinicio)
      image(nubeImg, nubeX, nubeY);

      if (capasActivas && mostrarCapaTemporal) {
        for (let capa of capas) {
          image(capa.img, capa.x, capa.y);
        }
      } else if (capasActivas && capaHover) {
        image(capaHover.img, capaHover.x, capaHover.y);
      } else if (capasActivas && capaActiva) {
        image(capaActiva.img, capaActiva.x, capaActiva.y);
      }

      if (capaHover) {
        fill(0);
        noStroke();
        text(capaHover.nombre, mouseX + 15, mouseY - 12);
      }

      mostrarConsola();
    }

    function mousePressed() {
      // Click nube â†’ iniciar/reeniciar
      if (mouseX >= nubeX && mouseX < nubeX + nubeImg.width && mouseY >= nubeY && mouseY < nubeY + nubeImg.height) {
        lluviaActiva = true;
        lluviaInicio = millis();
        mostrarNarracion1 = true;
        mostrarNarracion2 = false;
        capaActiva = null;
        capasActivas = false;
        setTimeout(() => {
          aguaActiva = true;
          rioClickable = true;
        }, 2000);
        return;
      }

      // Click rÃ­o â†’ mostrar capas
      if (rioClickable &&
          mouseX >= 411 && mouseX < 411 + aguaRioImg.width &&
          mouseY >= 266 && mouseY < 266 + aguaRioImg.height) {
        capasActivas = true;
        rioClickable = false;
        mostrarNarracion1 = false;
        mostrarNarracion2 = true;
        capaActiva = null;
        mostrarCapaTemporal = true;
        setTimeout(() => {
          mostrarCapaTemporal = false;
        }, 500);
        return;
      }

      // Click en capas (exploraciÃ³n)
      if (capasActivas) {
        for (let capa of capas) {
          if (mouseX >= capa.x && mouseX < capa.x + capa.img.width &&
              mouseY >= capa.y && mouseY < capa.y + capa.img.height) {
            let imgX = int(mouseX - capa.x);
            let imgY = int(mouseY - capa.y);
            let c = capa.img.get(imgX, imgY);
            if (c[3] > 10) {
              capaActiva = capa;
              mostrarNarracion1 = false;
              mostrarNarracion2 = false;
            }
          }
        }
      }
    }

    function mostrarConsola() {
      const alto = 230;
      const yBase = height - alto - 530;

      fill(255);
      stroke(0);
      rect(10, yBase, 500, alto);
      noStroke();
      fill(0);

      text("ðŸ›ˆ Instrucciones:", 20, yBase + 20);

      if (!aguaActiva) {
        text("- Presiona la nube para comenzar.", 20, yBase + 36);
      } else if (aguaActiva && !capasActivas) {
        text("- Presiona el rÃ­o para continuar.", 20, yBase + 36);
      } else {
        text("- Explora los elementos haciendo clic sobre ellos.", 20, yBase + 36);
      }

      text("Â¿QuÃ© estÃ¡ ocurriendo?:", 20, yBase + 58);
      let yTexto = yBase + 72;

      if (mostrarNarracion1) {
        text("Precipitaciones (lluvia y nieve) en alta cordillera: se activa el desarrollo de sistemas hÃ­dricos.", 20, yTexto, 460);
      }
      if (mostrarNarracion2) {
        text("EvaporaciÃ³n progresiva y precipitaciÃ³n de minerales: carbonatos, sulfatos y cloruros.", 20, yTexto, 460);
      }

      if (capaActiva) {
        if (capaActiva.imagenEjemplo) {
          image(capaActiva.imagenEjemplo, 25, yTexto + 10, 80, 80);
        }
        textStyle(BOLD);
        text(capaActiva.nombre, 120, yTexto + 30);
        textStyle(NORMAL);
        text(capaActiva.descripcion, 120, yTexto + 50, 370);
      }
    }
  </script>
</body>
</html>
